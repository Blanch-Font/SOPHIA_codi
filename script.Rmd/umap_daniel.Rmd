---
title: "Mapping to UKBioBank"
author: "JBF"
date: '`r Sys.time()`'
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(flextable)
library(ggplot2)
# library(dplyr)
# library(tidyr)
library(patchwork)
# library(purrr)
# library(umap)
# library(uwot)
library(gridExtra)
library(ClusterR)
library(splines)

# library(dbscan)
```

# Description
```{r}
bbdd_umap %>%
  summarise(name = 'total',
           N = as.character(n()),
           summary = '') %>%
  bind_rows(bbdd_umap %>%
              select(eid, sex, smoking) %>%
              mutate(smoking = as.character(smoking)) %>% 
              pivot_longer(cols = !eid) %>%
              group_by(name, value) %>%
              summarise(N = n(),
                        .groups = 'keep') %>%
              transmute(name,
                        value,
                        summary = sprintf('%i (%2.1f%%)', N, N/dim(bbdd_covar)[1]* 100))) %>% 
  bind_rows(bbdd_umap %>%
              select(-sex, -smoking) %>% 
              pivot_longer(cols = !eid) %>%
              group_by(name) %>%
              summarise(N = sum(!is.na(value)),
                        mn = mean(value, na.rm = T),
                        sd = sd(value, na.rm = T),
                        min = min(value, na.rm = T),
                        p025 = quantile(value, 0.025, na.rm = T),
                        q1 = quantile(value, 1/4, na.rm = T),
                        md = median(value, na.rm = T),
                        q3 = quantile(value, 3/4, na.rm = T),
                        p975 = quantile(value, 0.975, na.rm = T),
                        max = max(value, na.rm = T)) %>%
              transmute(name, 
                        N = sprintf('%i (%2.1f%%)', N, N/dim(bbdd_covar)[1]* 100),
                        summary = sprintf('%2.1f (%2.1f)', mn, sd),
                        min = sprintf('%2.1f', min),
                        p025 = sprintf('%2.1f', p025),
                        md_IQR = sprintf('%2.1f [%2.1f - %2.1f]', md, q1, q3),
                        p975 = sprintf('%2.1f', p975),
                        max = sprintf('%2.1f', max))) %>%
  select(name, value, N, summary, min, p025, md_IQR, p975, max) %>% 
  flextable %>%
  autofit
```

## Only Case-complet
```{r}
recoded_dat %>%
  summarise(name = 'total',
           N = as.character(n()),
           summary = '') %>%
  bind_rows(recoded_dat %>%
              select(eid, sex, smoking) %>%
              mutate(smoking = as.character(smoking)) %>% 
              pivot_longer(cols = !eid) %>%
              group_by(name, value) %>%
              summarise(N = n(),
                        .groups = 'keep') %>%
              group_by(name) %>%
              transmute(name,
                        value,
                        summary = sprintf('%i (%2.1f%%)', N, N/sum(N)* 100))) %>% 
  bind_rows(recoded_dat %>%
              select(-sex, -smoking) %>% 
              pivot_longer(cols = !eid) %>%
              group_by(name) %>%
              summarise(N = sum(!is.na(value)),
                        mn = mean(value, na.rm = T),
                        sd = sd(value, na.rm = T),
                        min = min(value, na.rm = T),
                        p025 = quantile(value, 0.025, na.rm = T),
                        q1 = quantile(value, 1/4, na.rm = T),
                        md = median(value, na.rm = T),
                        q3 = quantile(value, 3/4, na.rm = T),
                        p975 = quantile(value, 0.975, na.rm = T),
                        max = max(value, na.rm = T)) %>%
              transmute(name, 
                        N = sprintf('%i (%2.1f%%)', N, N/dim(recoded_dat)[1]* 100),
                        summary = sprintf('%2.1f (%2.1f)', mn, sd),
                        min = sprintf('%2.1f', min),
                        p025 = sprintf('%2.1f', p025),
                        md_IQR = sprintf('%2.1f [%2.1f - %2.1f]', md, q1, q3),
                        p975 = sprintf('%2.1f', p975),
                        max = sprintf('%2.1f', max))) %>%
  select(name, value, N, summary, min, p025, md_IQR, p975, max) %>% 
  flextable
```
## Distributions
```{r, fig.width=20, fig.height=5}
recoded_dat %>%
    pivot_longer(-c(eid, sex)) %>%
    mutate(name = toupper(name)) %>%
    ggplot(aes(value)) +
    geom_histogram(bins = 50) +
    facet_grid(sex ~ name, scales = "free_x") +
    theme_bw()
```

## Corretions
```{r, fig.width=18, fig.height=9}
recoded_dat %>%
    group_by(sex) %>%
    group_modify(~{
        .x %>%
            select(-eid, -crp) %>%
            cor %>%
            reshape2::melt()
    }) %>%
    mutate(rsq = value^2, 
           to_mark = ifelse(Var1 != Var2 & rsq > .25, "*", NA),
           across(c(Var1, Var2), toupper)) %>%
    ggplot(aes(Var1, Var2, fill = value)) +
    geom_tile() +
    geom_text(aes(label = to_mark), na.rm = TRUE) +
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, limit = c(-1,1)) +
    theme_minimal() +
    facet_wrap(~sex, nrow = 1) +
    labs(x = NULL, y = NULL, fill = "Correlation", caption = "* Squared correlation higher than 0.25")
```

# Stratification by sex and transformation
## Distribution
```{r, fig.width=20, fig.height=5}
strat_dat %>%
    bind_rows(.id = "sex") %>%
    pivot_longer(-c(eid, sex)) %>%
    mutate(name = toupper(name)) %>%
    ggplot(aes(value)) +
    geom_histogram(bins = 50) +
    facet_grid(sex ~ name, scales = "free_x")
```

## Correlations
```{r, fig.width=18, fig.height=9}
strat_dat %>%
  map_dfr(~{.x %>%
      select(-eid) %>%
      cor %>%
      reshape2::melt()
  }, .id = "sex") %>%
  mutate(rsq = value^2, 
         to_mark = ifelse(Var1 != Var2 & rsq > .25, "*", NA),
         across(c(Var1, Var2), toupper)) %>%
  ggplot(aes(Var1, Var2, fill = value)) +
  geom_tile() +
  geom_text(aes(label = to_mark), na.rm = TRUE) +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, limit = c(-1,1)) +
  theme_minimal() +
  facet_wrap(~sex, nrow = 1) +
  labs(x = NULL, y = NULL, fill = "Correlation", caption = "* Squared correlation higher than 0.25")
```

# Map to UKBioBank
```{r}
umap_embed %>%
  bind_rows(.id = "sex") %>%
  ggplot(aes(X1, X2)) +
  geom_point(shape = '.') +
  facet_wrap(~sex, nrow = 1) +
  theme_bw() +
  labs(x = "UMAP1", y = "UMAP2")

umap_embed %>%
  bind_rows(.id = "sex") %>%
  ggplot(aes(X1, X2)) +
  geom_point(shape = '.') +
  facet_wrap(~sex, nrow = 1) +
  scale_x_continuous(limits = c(-4, 3)) +
  scale_y_continuous(limits = c(-5, 5)) +
  theme_bw() +
  labs(x = "UMAP1", y = "UMAP2")

umap_embed %>%
  bind_rows(.id = "sex") %>%
  ggplot(aes(X1, X2)) +
  # geom_density_2d_filled() +
  ggdensity::geom_hdr() +
  facet_wrap(~sex, nrow = 1) +
  scale_x_continuous(limits = c(-4, 3)) +
  scale_y_continuous(limits = c(-5, 5)) +
  theme_bw() +
  labs(x = "UMAP1", y = "UMAP2", alpha = "Probability")
```

## Outlier
### Original data
```{r}
umap_embed_fora <- umap_embed %>%
  bind_rows(.id = "sex") %>%
  mutate(fora = 5 < X1^2 + X2^2)

bbdd_umap_fora <- bbdd_umap %>%
  inner_join(umap_embed_fora %>% select(eid, fora),
            by = 'eid')

bbdd_umap_fora %>%
  group_by(fora) %>% 
  summarise(name = 'total',
           N = as.character(n()),
           summary = '') %>%
  bind_rows(bbdd_umap_fora %>%
              group_by(fora) %>% 
              select(eid, fora, sex, smoking) %>%
              mutate(smoking = as.character(smoking)) %>% 
              pivot_longer(cols = !any_of(c('eid', 'fora'))) %>%
              group_by(fora, name, value) %>%
              summarise(N = n(),
                        .groups = 'keep') %>%
              group_by(fora, name) %>%
              transmute(fora,
                        name,
                        value,
                        summary = sprintf('%i (%2.1f%%)', N, N/sum(N)* 100))) %>% 
  bind_rows(bbdd_umap_fora %>%
              group_by(fora) %>% 
              select(-sex, -smoking) %>% 
              pivot_longer(cols = !any_of(c('eid', 'fora'))) %>%
              group_by(fora, name) %>%
              summarise(N = sum(!is.na(value)),
                        mn = mean(value, na.rm = T),
                        sd = sd(value, na.rm = T),
                        min = min(value, na.rm = T),
                        p025 = quantile(value, 0.025, na.rm = T),
                        q1 = quantile(value, 1/4, na.rm = T),
                        md = median(value, na.rm = T),
                        q3 = quantile(value, 3/4, na.rm = T),
                        p975 = quantile(value, 0.975, na.rm = T),
                        max = max(value, na.rm = T)) %>%
              transmute(fora,
                        name, 
                        N = sprintf('%i (%2.1f%%)', N, N/dim(bbdd_covar)[1]* 100),
                        summary = sprintf('%2.1f (%2.1f)', mn, sd),
                        min = sprintf('%2.1f', min),
                        p025 = sprintf('%2.1f', p025),
                        md_IQR = sprintf('%2.1f [%2.1f - %2.1f]', md, q1, q3),
                        p975 = sprintf('%2.1f', p975),
                        max = sprintf('%2.1f', max))) %>%
  select(fora, name, value, N, summary, min, p025, md_IQR, p975, max) %>%
  mutate(name = factor(name,
                       levels = c('total', 'sex', 'smoking', 'age', 'alt', 'bmi', 'crp', 'dbp',
                                  'fg', 'hdl', 'ldl', 'sbp', 'scr', 'tg', 'whr'))) %>% 
  arrange(name, fora, value) %>% 
  flextable %>%
  autofit

bbdd_umap_fora %>%
    pivot_longer(-c(eid, fora, sex)) %>%
    mutate(name = toupper(name)) %>%
    ggplot(aes(value)) +
    geom_histogram(bins = 50) +
    facet_grid(sex + fora ~ name, scales = "free_x") +
    theme_bw()
```

### Transformed data
```{r}
strat_dat_fora <- strat_dat %>%
  bind_rows(.id = "sex") %>%
  inner_join(umap_embed_fora %>% select(eid, fora),
            by = 'eid')

strat_dat_fora %>%
  group_by(fora) %>% 
  summarise(name = 'total',
           N = as.character(n()),
           summary = '') %>%
  bind_rows(strat_dat_fora %>%
              group_by(fora) %>% 
              select(eid, fora, sex) %>%
              pivot_longer(cols = !any_of(c('eid', 'fora'))) %>%
              group_by(fora, name, value) %>%
              summarise(N = n(),
                        .groups = 'keep') %>%
              group_by(fora, name) %>%
              transmute(fora,
                        name,
                        value,
                        summary = sprintf('%i (%2.1f%%)', N, N/sum(N)* 100))) %>% 
  bind_rows(strat_dat_fora %>%
              group_by(fora) %>% 
              select(-sex) %>% 
              pivot_longer(cols = !any_of(c('eid', 'fora'))) %>%
              group_by(fora, name) %>%
              summarise(N = sum(!is.na(value)),
                        mn = mean(value, na.rm = T),
                        sd = sd(value, na.rm = T),
                        min = min(value, na.rm = T),
                        p025 = quantile(value, 0.025, na.rm = T),
                        q1 = quantile(value, 1/4, na.rm = T),
                        md = median(value, na.rm = T),
                        q3 = quantile(value, 3/4, na.rm = T),
                        p975 = quantile(value, 0.975, na.rm = T),
                        max = max(value, na.rm = T)) %>%
              transmute(fora,
                        name, 
                        N = sprintf('%i', N),
                        summary = sprintf('%2.1f (%2.1f)', mn, sd),
                        min = sprintf('%2.1f', min),
                        p025 = sprintf('%2.1f', p025),
                        md_IQR = sprintf('%2.1f [%2.1f - %2.1f]', md, q1, q3),
                        p975 = sprintf('%2.1f', p975),
                        max = sprintf('%2.1f', max))) %>%
  select(fora, name, value, N, summary, min, p025, md_IQR, p975, max) %>%
  mutate(name = factor(name,
                       levels = c('total', 'sex', 'smoking', 'age', 'alt', 'bmi', 'crp', 'dbp',
                                  'fg', 'hdl', 'ldl', 'sbp', 'scr', 'tg', 'whr'))) %>% 
  arrange(name, fora, value) %>% 
  flextable %>%
  autofit

strat_dat_fora %>%
    pivot_longer(-c(eid, fora, sex)) %>%
    mutate(name = toupper(name)) %>%
    ggplot(aes(value)) +
    geom_histogram(bins = 50) +
    facet_grid(sex + fora ~ name, scales = "free_x") +
    theme_bw()
```


## Overlaying input variables
```{r, fig.width=9, fig.height=12}
umap_embed %>%
  bind_rows(.id = "sex") %>%
  {
    d <- recoded_dat %>% 
      select(eid, sex, age, bmi, smoking)
    inner_join(., d, by = c("eid", "sex"))
  } %>%
  pivot_longer(c(age, bmi, smoking)) %>%
  split(f = .$name) %>%
  imap(~{
    mp <- median(.x$value)
    .x %>%
      ggplot(aes(X1, X2)) +
      geom_point(aes(color = value), shape = '.') +
      scale_color_gradient2(midpoint = mp, high = "red", low = "blue") +
      facet_wrap(~sex, nrow = 1) +
      theme_bw() +
      labs(x = "UMAP1", y = "UMAP2", 
           title = ifelse(.y == "bmi", "BMI", stringr::str_to_title(.y)), 
           color = NULL)
  }) %>%
  wrap_plots(ncol = 1)
```

```{r, fig.height=5, fig.width=15}
umap_embed %>%
  map2_dfr(strat_dat,
           inner_join,
           by = "eid",
           .id = "sex") %>%
  tidyr::pivot_longer(-c(X1, X2, sex, eid)) %>%
  mutate(name = toupper(name)) %>% #, 
  ggplot(aes(X1, X2)) +
  geom_point(aes(color = value), shape = '.') +
  scale_color_gradient2(limits = c(-10, 10), low = scales::muted("blue"), high = scales::muted("red")) +
  facet_grid(sex ~ name) +
  theme_bw() +
  theme(panel.grid = element_blank(), legend.position = "top") +
  labs(x = NULL, y = NULL, color = "Value")
```

## Correlation between UMAP axes and input variables
```{r, fig.width=10, fig.height=7}
umap_embed %>%
  map2_dfr(strat_dat, inner_join, by = "eid", .id = "sex") %>%
  {
    d <- select(recoded_dat, eid, sex, age, smoking, bmi)
    inner_join(., d, by = c("eid", "sex"))
  } %>%
  tidyr::pivot_longer(-c(sex, eid, X1, X2)) %>%
  group_by(sex, name) %>%
  group_modify(~{ .x %>%
      with(data.frame(umap_axis = c("UMAP1", "UMAP2"),
                      Correlation = c(cor(X1, value), cor(X2, value))))
  }) %>%
  mutate(name = toupper(name)) %>%
  group_by(sex, umap_axis) %>%
  group_map(~{.x %>%
      ggplot(aes(Correlation, reorder(name, abs(Correlation)))) +
      geom_vline(xintercept = 0, lty = "dashed") +
      geom_segment(aes(xend = 0, yend = reorder(name, abs(Correlation)))) +
      geom_point(color = "red") +
      theme_bw() +
      labs(x = NULL, y = NULL, title = paste(.y$sex, "-", .y$umap_axis))
  }) %>%
  wrap_plots
```

## Archetypes
```{r, fig.width=11, fig.height=5}
map(c("Female", "Male"),
    ~{umap_embed[[.x]] %>%
        ggplot(aes(X1, X2)) +
        geom_point(shape = '.') +
        geom_point(data = archdat_umap[[.x]], aes(fill = archnam), shape = 23, size = 3) +
        theme_bw() +
        labs(x = "UMAP1", y = "UMAP2", title = .x, fill = "Archetypes")
    }) %>%
  wrap_plots(nrow = 1)
```

## Distribution of probabilities
```{r, fig.width = 12, fig.height = 4}
arch_probs_long %>%
    bind_rows(.id = "sex") %>%
    ggplot(aes(archnam, prob)) +
    geom_boxplot(aes(group = archnam, fill = archnam)) +
    theme_bw() +
    theme(legend.position = "none") +
    facet_wrap(~sex, ncol = 1) +
    labs(x = NULL, y = "Probability")
```

## Maximum probabilities
```{r, fig.width = 11, fig.height = 5}
arch_maxprob <- arch_probs_long %>%
  map(group_by, eid) %>%
  map(slice_max, prob, with_ties = FALSE)
umap_embed %>%
    # map(pluck, "embedding") %>%
    # map(data.frame) %>%
    # map2(strat_dat, ~.y %>% select(eid) %>% bind_cols(.x)) %>%
    map2_dfr(arch_maxprob, inner_join, by = "eid", .id = "sex") %>%
    ggplot(aes(X1, X2)) +
    geom_point(aes(color = archnam, alpha = prob), shape = '.') +
    guides(color = guide_legend(override.aes = list(shape = 19))) +
    scale_alpha_identity() +
    facet_wrap(~sex, nrow = 1) +
    theme_bw() +
    labs(x = "UMAP1", y = "UMAP2", color = "Archetypes")
```

```{r, fig.width = 20, fig.height = 5}
arch_maxprob %>%
  imap(~{
    d <- umap_embed[[.y]]
    .x %>%
      split(f = .$archnam) %>%
      map(function(ARCH){
        dd <- inner_join(ARCH, d, by = "eid")
        d %>%
          ggplot(aes(X1, X2)) +
          geom_point(shape = '.', alpha = .1) +
          geom_point(data = dd, color = "red", alpha = .5, size = .2) +
          theme_bw() +
          labs(x = NULL, y = NULL, title = ARCH$archnam[1])
        }) %>%
      modify_at(1, function(g){ g + labs(y = .y) }) %>%
      wrap_plots(nrow = 1)
    }) %>%
  wrap_plots(nrow = 2)
```

```{r}
umap_embed %>%
  map2_dfr(arch_maxprob, inner_join, by = "eid", .id = "sex") %>%
  filter(prob > .5) %>%
  ggplot(aes(X1, X2)) +
  geom_point(aes(color = archnam, alpha = prob), size = .25) +
  guides(color = guide_legend(override.aes = list(size = 1))) +
  scale_alpha_identity() +
  facet_wrap(~sex, nrow = 1) +
  theme_bw() +
  labs(x = "UMAP1", y = "UMAP2", color = "Archetypes")
```

## Overlaying prevalent diseases
```{r, fig.width = 20, fig.height = 10}
umap_disease %>%
    imap(~{
      .x %>%
        tidyr::pivot_longer(any_of(c("angor", "tia", "stroke", "ami", "COPD", "CKD", "cancer",
                                     "depress", "htn", "hf", "liver", "ra", "sleep_apnea",
                                     "pcos")),
                            names_to = "Disease",
                            values_to = "Diagnosis") %>%
        mutate(Disease = gsub("_", " ", Disease),
               Diagnosis = ifelse(Diagnosis == 1, "Yes", "No")) %>%
        ggplot(aes(X1, X2)) +
        geom_point(aes(color = Diagnosis, 
                       shape = ifelse(Diagnosis == "Yes", "*", "."),
                       alpha = ifelse(Diagnosis == "Yes", .5, .1)),
                   na.rm = TRUE) +
        scale_shape_identity() +
        scale_alpha_identity() +
        scale_color_manual(values = c("grey", "red")) +
        guides(color = guide_legend(override.aes = list(alpha = 1))) +
        geom_point(data = archdat_umap[[.y]], aes(fill = archnam), shape = 23, size = 3) +
        facet_wrap(~Disease, nrow = 2) +
        theme_bw() +
        labs(title = .x$sex[1], x = "UMAP1", y = "UMAP2", fill = paste("Archetypes -", .y))
    }) %>%
  patchwork::wrap_plots(ncol = 1, guides = "collect")
```

